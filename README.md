# RAG Chat Storage Microservice

A production-ready backend microservice for storing chat histories generated by RAG (Retrieval-Augmented Generation) based chatbot systems. Built with Java 21, Spring Boot 3.2, and PostgreSQL.

## Features

- **Chat Session Management**: Create, rename, favorite/unfavorite, and delete chat sessions
- **Message Storage**: Store messages with sender, content, timestamp, and optional RAG context
- **API Key Authentication**: Secure all endpoints with API key authentication
- **Rate Limiting**: Prevent API abuse with configurable rate limits
- **Pagination Support**: Paginated retrieval of sessions and messages
- **Health Checks**: Liveness and readiness endpoints for monitoring
- **Swagger/OpenAPI**: Interactive API documentation
- **CORS Support**: Configurable cross-origin resource sharing
- **Centralized Logging**: Request/response logging with unique request IDs
- **Global Error Handling**: Consistent error responses across all endpoints

## Tech Stack

- **Language**: Java 21
- **Framework**: Spring Boot 3.2
- **Database**: PostgreSQL 15+
- **ORM**: Spring Data JPA / Hibernate
- **Security**: Spring Security with API Key authentication
- **Documentation**: Springdoc OpenAPI (Swagger UI)
- **Rate Limiting**: Bucket4j
- **Build Tool**: Maven

## Project Structure

```
src/
├── main/
│   ├── java/com/ragchat/
│   │   ├── config/          # Configuration classes
│   │   ├── controller/      # REST controllers
│   │   ├── dto/             # Data Transfer Objects
│   │   ├── entity/          # JPA entities
│   │   ├── exception/       # Exception handling
│   │   ├── filter/          # Request filters
│   │   ├── repository/      # JPA repositories
│   │   ├── service/         # Business logic
│   │   └── RagChatStorageApplication.java
│   └── resources/
│       └── application.properties
└── test/
    └── java/com/ragchat/
        └── service/         # Unit tests
```

## Setup Instructions

### Prerequisites

- Java 21 or higher
- Maven 3.8+
- PostgreSQL 15+ (or Docker for containerized setup)

### Environment Variables

Copy `.env.example` to `.env` and configure:

```bash
cp .env.example .env
```

| Variable | Description | Default |
|----------|-------------|---------|
| `DATABASE_URL` | PostgreSQL connection URL | - |
| `API_KEY` | API key for authentication | `default-api-key-change-me` |
| `CORS_ALLOWED_ORIGINS` | Allowed CORS origins | `*` |
| `RATE_LIMIT_REQUESTS_PER_MINUTE` | Rate limit per minute | `60` |
| `RATE_LIMIT_BURST_CAPACITY` | Burst capacity | `10` |

### Running Locally

1. **Start PostgreSQL** (if not using Docker):
   ```bash
   # Make sure PostgreSQL is running and create the database
   createdb ragchat
   ```

2. **Set environment variables**:
   ```bash
   export DATABASE_URL=jdbc:postgresql://localhost:5432/ragchat
   export API_KEY=your-secure-api-key
   ```

3. **Build and run**:
   ```bash
   mvn clean install
   mvn spring-boot:run
   ```

### Running with Docker

```bash
# Build and start all services
docker-compose up -d

# View logs
docker-compose logs -f app

# Stop services
docker-compose down
```

This will start:
- **app**: The microservice on port 5000
- **db**: PostgreSQL database on port 5432
- **adminer**: Database management UI on port 8080

## API Documentation

### Swagger UI

Access the interactive API documentation at:
```
http://localhost:5000/swagger-ui.html
```

### API Endpoints

All endpoints (except health checks and Swagger) require the `X-API-Key` header.

#### Health Endpoints (No Authentication)

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/v1/health` | Basic health check |
| GET | `/api/v1/health/ready` | Readiness check (includes DB) |
| GET | `/api/v1/health/live` | Liveness check |

#### Session Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/sessions` | Create a new session |
| GET | `/api/v1/sessions/{sessionId}` | Get session by ID |
| GET | `/api/v1/sessions/user/{userId}` | Get all sessions for a user |
| GET | `/api/v1/sessions/user/{userId}/paginated` | Get paginated sessions |
| GET | `/api/v1/sessions/user/{userId}/favorites` | Get favorite sessions |
| PATCH | `/api/v1/sessions/{sessionId}` | Update session |
| PATCH | `/api/v1/sessions/{sessionId}/rename` | Rename session |
| PATCH | `/api/v1/sessions/{sessionId}/favorite` | Toggle favorite |
| DELETE | `/api/v1/sessions/{sessionId}` | Delete session |

#### Message Endpoints

| Method | Endpoint | Description |
|--------|----------|-------------|
| POST | `/api/v1/sessions/{sessionId}/messages` | Add message to session |
| GET | `/api/v1/sessions/{sessionId}/messages` | Get all messages |
| GET | `/api/v1/sessions/{sessionId}/messages/paginated` | Get paginated messages |
| GET | `/api/v1/sessions/{sessionId}/messages/count` | Get message count |
| GET | `/api/v1/messages/{messageId}` | Get message by ID |
| DELETE | `/api/v1/messages/{messageId}` | Delete message |

### Example Requests

#### Create a Session

```bash
curl -X POST http://localhost:5000/api/v1/sessions \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{
    "userId": "user-123",
    "title": "My First Chat"
  }'
```

#### Add a Message

```bash
curl -X POST http://localhost:5000/api/v1/sessions/{sessionId}/messages \
  -H "Content-Type: application/json" \
  -H "X-API-Key: your-api-key" \
  -d '{
    "sender": "USER",
    "content": "What is the capital of France?",
    "context": "Retrieved document about European capitals..."
  }'
```

#### Get Messages with Pagination

```bash
curl -X GET "http://localhost:5000/api/v1/sessions/{sessionId}/messages/paginated?page=0&size=20" \
  -H "X-API-Key: your-api-key"
```

### Response Format

All responses follow a consistent format:

```json
{
  "success": true,
  "message": "Success",
  "data": { ... },
  "timestamp": "2024-01-15T10:30:00"
}
```

Error responses:

```json
{
  "success": false,
  "message": "Error description",
  "timestamp": "2024-01-15T10:30:00"
}
```

## Rate Limiting

The API implements rate limiting to prevent abuse:
- **60 requests per minute** per client (configurable)
- **10 burst requests** allowed per second
- Rate limit exceeded returns HTTP 429 with `Retry-After` header

## Security

- **API Key Authentication**: All protected endpoints require `X-API-Key` header
- **CORS**: Configurable allowed origins
- **Input Validation**: All inputs are validated
- **SQL Injection Prevention**: Using parameterized queries via JPA
- **Non-root Docker User**: Container runs as non-privileged user

## Running Tests

```bash
# Run all tests
mvn test

# Run with coverage report
mvn test jacoco:report
```

## License

MIT License
